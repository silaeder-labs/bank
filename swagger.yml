openapi: 3.0.3
info:
  title: Bank Transactions API
  description: |
    API для управления транзакциями и просмотра информации о балансе.
    Все запросы требуют JWT в заголовке Authorization: Bearer <token>.
  version: 1.0.0
servers:
  - url: https://api.bank.example.com
security:
  - bearerAuth: []
paths:
  /transactions:
    post:
      summary: Создать перевод
      description: Создает исходящий перевод с текущего пользователя на другого.
      operationId: createTransaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTransactionRequest'
            examples:
              default:
                value:
                  target_id: a1b2c3d4-0000-4000-8000-000000000001
                  amount: 1500.25
                  comment: Подарок за помощь
      responses:
        '201':
          description: Транзакция успешно создана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionFull'
        '400':
          description: Ошибка валидации входных данных
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: JWT отсутствует или недействителен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
        '404':
          description: Получатель не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
        '409':
          description: Недостаточно средств для совершения перевода
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
    get:
      summary: Получить список своих транзакций
      description: Возвращает список транзакций текущего пользователя с пагинацией.
      operationId: listTransactions
      parameters:
        - name: page
          in: query
          description: Номер страницы, начиная с 1
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: size
          in: query
          description: Размер страницы (макс. 100)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: Страница транзакций пользователя
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionListResponse'
        '401':
          description: JWT отсутствует или недействителен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
  /transactions/{transactionId}:
    parameters:
      - name: transactionId
        in: path
        required: true
        description: UUID транзакции
        schema:
          type: string
          format: uuid
    get:
      summary: Получить детали транзакции
      operationId: getTransactionById
      responses:
        '200':
          description: Детали транзакции
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionFull'
        '401':
          description: JWT отсутствует или недействителен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
        '404':
          description: Транзакция не найдена или не принадлежит пользователю
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
  /profile/me:
    get:
      summary: Получить информацию о текущем пользователе
      operationId: getProfile
      responses:
        '200':
          description: Профиль пользователя с балансом
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileSummary'
        '401':
          description: JWT отсутствует или недействителен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ErrorCode:
      type: string
      description: Код ошибки (машиночитаемый). Используется для обработки ошибок на клиенте.
      enum:
        - BAD_REQUEST
        - VALIDATION_FAILED
        - UNAUTHORIZED
        - FORBIDDEN
        - INTERNAL_SERVER_ERROR
        - USER_NOT_FOUND
        - TRANSACTION_NOT_FOUND
        - INSUFFICIENT_FUNDS
        - INVALID_JWT
    ApiError:
      type: object
      required: [code, message, traceId, timestamp, path]
      description: Стандартный формат ошибки API. Все ошибки кроме 2xx возвращаются в этом виде.
      properties:
        code:
          $ref: '#/components/schemas/ErrorCode'
        message:
          type: string
          description: Человекочитаемое сообщение (для отображения пользователю)
          example: Неверный запрос
        traceId:
          type: string
          format: uuid
          description: |
            Уникальный идентификатор запроса для трейсинга.
            Позволяет сопоставить ошибку с логами.
          example: "[UUID73]"
        timestamp:
          type: string
          format: date-time
          description: Время возникновения ошибки (ISO 8601, UTC)
        path:
          type: string
          description: Путь запроса, на котором произошла ошибка
          example: /api/v1/transactions
        details:
          type: object
          additionalProperties: true
          description: Дополнительные детали ошибки
    FieldError:
      type: object
      required: [field, issue]
      properties:
        field:
          type: string
          description: Имя поля с ошибкой (может быть вложенным, например "location.latitude")
          example: amount
        issue:
          type: string
          description: Описание проблемы
          example: must be >= 0.01
        rejectedValue:
          description: Значение, которое не прошло валидацию
          nullable: true
    ValidationError:
      type: object
      required: [code, message, traceId, timestamp, path, fieldErrors]
      description: Структура ошибки валидации, содержит ошибки по полям.
      properties:
        code:
          type: string
          example: VALIDATION_FAILED
        message:
          type: string
        traceId:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        path:
          type: string
        fieldErrors:
          type: array
          items:
            $ref: '#/components/schemas/FieldError'
    CreateTransactionRequest:
      type: object
      required: [target_id, amount]
      properties:
        target_id:
          type: string
          format: uuid
          description: UUID получателя
        amount:
          type: number
          minimum: 0.01
          description: Сумма перевода в валюте счета
          example: 1200.5
        comment:
          type: string
          maxLength: 100
          description: Комментарий к транзакции
    TransactionFull:
      type: object
      required: [id, createdAt, amount, source, target, comment, status]
      properties:
        id:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
          description: Время проведения транзакции в UTC
        amount:
          type: number
          description: Сумма перевода
        source:
          type: object
          required: [id]
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
        target:
          type: object
          required: [id]
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
        comment:
          type: string
          description: Комментарий отправителя
        status:
          type: string
          enum: [PENDING, COMPLETED, FAILED]
        metadata:
          type: object
          additionalProperties: true
          description: Системные метаданные транзакции
    TransactionListResponse:
      type: object
      properties:
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/TransactionFull'
        total:
          type: integer
          description: Общее количество транзакций (доступных)
        page:
          type: integer
          description: Текущая запрошенная страница
        size:
          type: integer
          description: Размер страницы
    ProfileSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        balance:
          type: number
          description: Текущий баланс пользователя (может быть отрицательным)
        total_transactions:
          type: integer
          description: Количество завершенных транзакций
